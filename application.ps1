$applications = Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion, Publisher
$count=0

$outfile = "$pwd\application_vuln.csv"
Remove-Item $outfile -Force

$unique=0

$applications | ForEach-Object ($_) {

$appsfound = 0
$value=Get-Content $pwd\value.txt
#write-host $value 

$check = $applications[$count].DisplayName+", "+$applications[$count].Displayversion
$check = $check -replace ' ','+'

Write-Host $check

$html = Invoke-WebRequest -Uri "https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=$check"
$output = $html.Links | ForEach-Object -MemberName innertext | Select-String "CVE-"

    foreach ($_ in $output) {

    #imposed limit of 50, due to how the vulnerabilties are displayed on the website, this will display the newest 50, the most threatening group.
        if ($appsfound -lt $value) {

            #writing out each member of the object as a string that can be utilised by PS
            $CVE = $_

            $html2 = Invoke-WebRequest -Uri "https://nvd.nist.gov/vuln/search/results?form_type=Basic&results_type=overview&query=$CVE"
            $output2 = $html2.ParsedHtml.all.tags("td") | ForEach-Object -MemberName innertext 


            $html3 = Invoke-WebRequest -Uri "https://nvd.nist.gov/vuln/detail/$CVE"
            $output3 = $html3.ParsedHtml.getElementById("Cvss3NistCalculatorAnchor") | ForEach-Object -MemberName textcontent
            #write-host $output3
           
            #Write-Host $CVE
            


            #custom object which exports data to a csv file for use external to this script.
            if ($applications[$count].DisplayName -gt 3) {
                    [pscustomobject]@{
                    unique_value = $unique++
                    App_Name =  $applications[$count].DisplayName
                    App_Version =$applications[$count].Displayversion
                    CVE = $cve
                    Publisher = $applications[$count].Publisher
                    Risk = $output3
                    Comment = (@($output2) -join ',')

                    } | export-csv -NoTypeInformation -Path $outfile -Append
            }
                else {break}
            $appsfound++
        }
        else {break}

    }
write-host $appsfound
$count++
} 
Remove-Item $pwd\value.txt -Force


