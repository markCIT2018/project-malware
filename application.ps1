$applications = Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion, Publisher, quietuninstallstring
$count=0

$outfile = "$pwd\application_vuln.csv"
Remove-Item $outfile -Force

$unique=01

$applications | ForEach-Object ($_) {

$appsfound = 0
$value=Get-Content $pwd\value.txt
#write-host $value 

$check = $applications[$count].DisplayName
$check = $check -replace ' ','+'
#$applications[$count].quietuninstallstring = "& "+ $applications[$count].quietuninstallstring

Write-Host $check

$html = Invoke-WebRequest -Uri "https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=$check"
$output = $html.Links | ForEach-Object -MemberName innertext | Select-String "CVE-"

    foreach ($_ in $output) {

    #imposed limit of 50, due to how the vulnerabilties are displayed on the website, this will display the newest 50, the most threatening group.
        if ($appsfound -lt $value) {

            #writing out each member of the object as a string that can be utilised by PS
            $CVE = $_

            $html2 = Invoke-WebRequest -Uri "https://nvd.nist.gov/vuln/search/results?form_type=Basic&results_type=overview&query=$CVE" 
            $output2 = $html2.ParsedHtml.all.tags("td") | ForEach-Object -MemberName innertext | Select-Object -First 1
            $output2 = $output2 -replace ',' + ' '
            $output2 = $output2 -split "Published:" | Select-Object -First 1
            

          # Write-Host $output2

            $html3 = Invoke-WebRequest -Uri "https://nvd.nist.gov/vuln/detail/$CVE"
            $output3 = $html3.ParsedHtml.getElementById("Cvss3NistCalculatorAnchor") | ForEach-Object -MemberName textcontent
           
            #write-host $output3
           
            #Write-Host $CVE
           
            $publisher = $applications[$count].Publisher -replace ','+ ' '

        #   Write-Host $applications[$count].quietuninstallstring
            if ($output3.length -lt 1)  {
            $output3 = "Undetermined"}
            $appV = $applications[$count].Displayversion

            if ($appv.length -lt 1 ){
            $appv = "Unknown"}
            $appname =  $applications[$count].DisplayName -replace ','

            #custom object which exports data to a csv file for use external to this script.
            if ($applications[$count].DisplayName -gt 3) {
                    [pscustomobject]@{
                    unique_value = $unique++
                    App_Name =   $appname
                    App_Version =$appV
                    CVE = $cve
                    Publisher = $publisher
                    Risk = $output3
                    Comment = $output2

                    } | export-csv -NoTypeInfo -Path $outfile -Append 
            }
                else {break}
            $appsfound++
        }
        else {break}

    }
#write-host $appsfound
$count++
} 
#Remove-Item $pwd\value.txt -Force


$i = 1
Get-Content $outfile | Where-Object { $i % 2 -eq 0; $i++ } | Add-Content "application_vuln_clean.csv"

Remove-Item $outfile -Force
rename-item "application_vuln_clean.csv" -newname "application_vuln.csv"