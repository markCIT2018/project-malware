Remove-Item nmapoutput* -Force

$outfile = "$pwd\network_vuln.csv"

$appfound = 0
$unique=0
$count = 0

$env:HostIP = (
    Get-NetIPConfiguration |
    Where-Object {
        $_.IPv4DefaultGateway -ne $null -and
        $_.NetAdapter.Status -ne "Disconnected"
    }
).IPv4Address.IPAddress

Write-Host $env:HostIP

nmap -sV $env:HostIP -oA nmapoutput
[xml]$xmlDocument = Get-Content -Path $pwd\nmapoutput.xml
$value=Get-Content $pwd\net.txt
$port= $xmlDocument.nmaprun.host.ports.port.count
Write-Host `n
while($count -ne $port){

    $name = [string]$xmlDocument.nmaprun.host.ports.port.service.name[$count]
    $service = [string]$xmlDocument.nmaprun.host.ports.port.service[$count].product
    $version = [string]$xmlDocument.nmaprun.host.ports.port.service[$count].version

    if ($service.Length -eq 0 ){
        $service = $name
     #   write-host $service
    }else {
     #   write-host $service
    }

    if ($version.Length -eq 0 ){

    }else{ 
      #  write-host $version
    }



   
   $check = $service +" "+ $version
   $check = $check -replace ' ','+'
   $check = $check -replace "-",'+'
   Write-Host $check

   $url = "https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=$check"
   $HTML = Invoke-WebRequest -Uri $url
   $output = $HTML.Links | ForEach-Object -MemberName innertext | Select-String "CVE-"
   

   foreach ($_ in $output) {
   if ($appfound -eq $value){break}
   Write-Host $appfound

            #writing out each member of the object as a string that can be utilised by PS
            $CVE = $_

            $url2 = "https://nvd.nist.gov/vuln/search/results?form_type=Basic&results_type=overview&query=$CVE"
            $html2 = Invoke-WebRequest -Uri $url2
            $output2 = $html2.ParsedHtml.all.tags("td") | ForEach-Object -MemberName innertext


            Write-Host $CVE
           # Write-Host $output2
            $appfound++
            [pscustomobject]@{
                            unique_value = $unique++
                            App_Name =  $service
                            App_Version =$version
                            CVE = $CVE
                            Comment = (@($output2) -join ',')

                            } | export-csv -NoTypeInformation -Path $outfile -Append
                            

                            }





    $appfound = 0
    $count++



}
Remove-Item nmapoutput* -Force
remove-item net.txt